#!/bin/bash
#
# bash completion file for pygmentize-addons


_executables(){
    echo -n "$PATH" | xargs -d: -I{} -- find -L {} -maxdepth 1 -type f -executable -printf '%P\n' 2>/dev/null | sort -u
}

__pyg(){

    local cur prev script

    COMPREPLY=()

    script=${COMP_WORDS[0]}
    cur=${COMP_WORDS[COMP_CWORD]}
    prev=${COMP_WORDS[COMP_CWORD-1]}

    case $prev in
        --lexer)
            # cache lexers in global namespace
            if hash pygmentize &>/dev/null && [[ -z $__pyg_lexers ]]; then
                __pyg_lexers=$(pygmentize -L lexers 2>/dev/null | awk '/^* .+:$/ {sub("^* ", ""); gsub(",", ""); sub(":$", ""); print}' | paste -sd' ')
            fi

            readarray -t COMPREPLY < <(compgen -W "$__pyg_lexers" -- "$cur")
            return 0
            ;;
        -*x|--executable)
            readarray -t COMPREPLY < <(compgen -W "$(_executables)" -- "$cur")
            return 0
            ;;
    esac

    if [[ $cur = -* ]]; then
        options=(--executable -f --force -h --help --lexer -x)

        if [[ $script = pygshit ]]; then
            options+=(-l --less)
        elif [[ $script = pygsparkle ]]; then
            options+=(--gui)
        fi

        readarray -t COMPREPLY < <(compgen -W "${options[*]}" -- "$cur")
        return 0
    fi

}

hash pygshit &>/dev/null && complete -F __pyg -o default pygshit

hash pygsparkle &>/dev/null && complete -F __pyg -o default pygsparkle
